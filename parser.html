<!DOCTYPE html>
<!--[if lt IE 7]> <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>    <html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>    <html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class=""> <!--<![endif]-->
	<head>  
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<canvas id="domCanvas" width="800" height="400" style="border: 1px solid #f00"></canvas> <br />
		<textarea cols="50" rows="10" id="txtInput">{"boundaries":[[[0,2],[1,0]],[[3,1]],[[2,4]],[[5,3]],[],[[7,5]],[[6,8]],[[9,7]],[[8,10]],[[10,11]],[[12,9]],[[13,12]],[[11,6]],[[4,13]]],"neighbours":[[1],[2,0],[1,3],[2,4],[13,3,5],[4,6],[5,7],[8,6],[7,9],[10,8],[11,9],[12,10],[13,11],[4,12]],"points":[[268,343],[79,332],[245,131],[80,53],[504,135],[675,64],[606,262],[691,336],[615,309],[376,336],[434,308],[435,264],[365,233],[505,231]],"triangles":[[0,1,2],[1,3,2],[4,2,3],[5,4,3],[5,6,4],[7,6,5],[7,8,6],[7,9,8],[9,10,8],[10,9,11],[11,9,12],[11,12,13],[11,13,6],[6,13,4]]}</textarea>
		<button id="btnParse">Parse</button>
		<button id="btnGraph">Render graph</button>
		<button id="btnStart">Start point</button>
		<button id="btnEnd">End point</button>
		<button id="btnPath">Show path</button>
		<script src="dist/NavigationMesh.js"></script>
		<script type="text/javascript">

			var startPoint = new Point( 0, 0 );
			var endPoint = new Point( 0, 0 );
			var MODE = 2;
			var MODES = {
				"START": 0,
				"END": 1,
				"AUTO": 2,
				"COSTS": 3
			};


			var renderer = new Renderer( document.getElementById("domCanvas") );
			renderer.on("click", function( e ){

				if( MODE === MODES.START ){
					startPoint.x = e.offsetX;
					startPoint.y = e.offsetY;
					MODE = MODES.AUTO;
					renderGraph();
					return;
				}
				if( MODE === MODES.END ){
					endPoint.x = e.offsetX;
					endPoint.y = e.offsetY;
					MODE = MODES.AUTO;
					renderGraph();
					return;
				}

				var node = mesh.graph.containsPoint( e.offsetX, e.offsetY );
				mesh.triangles.forEach(function(triangle){
					triangle.fill = "none";
				});
				if( !node ) return;
				node.triangle.fill = "rgba(0,0,255,0.2)";
				renderGraph();
			});

			renderer.el.addEventListener("mousemove", function( e ){
				var x = e.offsetX;
				var y = e.offsetY;
				var ctx = renderer.ctx;
				ctx.save();
				ctx.fillStyle = "#fff";
				ctx.fillRect(0, 0, 50, 20 );
				ctx.fillStyle = "#000";
				ctx.font = "10px Arial";
				ctx.fillText( x + "," + y, 10, 10 );
				ctx.restore();
			});

			var stage = new Stage();
			renderer.stage = stage;

			var mesh = null;

			document.getElementById("btnParse").addEventListener("click", function(){
				mesh = new NavigationMesh();
				mesh.parse( JSON.parse( document.getElementById("txtInput").value ) );
				stage.addChild( mesh.triangles );
				renderer.render();
			});


			/**
			 * DEBUG RENDER BITS
			 */

			function renderGraph(){
				renderer.clear();
				renderer.render();

				var graph = mesh.graph;
				var neighbour;
				var circle = new Circle(0,0,4);
				circle.fill = "#0f0";
				var link = new Line( 0, 0, 0, 0 );
				link.stroke = "#00f";
				var node1;
				var node2;
				renderer.ctx.globalAlpha = 0.5;
				Object.keys( graph.links ).forEach(function( key ){
					node1 = graph.getNodeById( graph.links[ key ].a );
					node2 = graph.getNodeById( graph.links[ key ].b );
					link.x1 = node1.x;
					link.y1 = node1.y;
					link.x2 = node2.x;
					link.y2 = node2.y;
					link.render( renderer.ctx );
				});
				graph.nodes.forEach(function( node ){
					circle.cx = node.x;
					circle.cy = node.y;
					circle.render( renderer.ctx );	
				});
				renderer.ctx.globalAlpha = 1.0;

				// Render startPoint and endPoint
				circle.fill = "#FF00FF";
				circle.cx = startPoint.x;
				circle.cy = startPoint.y;
				circle.render( renderer.ctx );
				circle.fill = "#FF7F00";
				circle.cx = endPoint.x;
				circle.cy = endPoint.y;
				circle.render( renderer.ctx );
			}
			document.getElementById("btnGraph").addEventListener("click", renderGraph);

			document.getElementById("btnStart").addEventListener("click", function(){
				MODE = MODES.START;
			});
			document.getElementById("btnEnd").addEventListener("click", function(){
				MODE = MODES.END;
			});

			document.getElementById("btnPath").addEventListener("click", function(){
				var path = mesh.calculatePath( startPoint, endPoint );
				var line = new Line();
				line.strokeWidth = 5;
				line.stroke = "#000";
				// path.forEach(function( node ){
				// 	node.triangle.fill = "#00FFD8";
				// 	node.triangle.render( renderer.ctx );
				// 	node.triangle.fill = "none";
				// });
				path.reduce(function( previous, current ){
					if( previous !== null ){
						line.x1 = previous.x;
						line.y1 = previous.y;
						line.x2 = current.x;
						line.y2 = current.y;
						line.render( renderer.ctx );
					}
					return current;
				});
			});
			
		</script>
	</body>
</html>