<!DOCTYPE html>
<html>
	<head>  
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
	</head>
	<body>
		<canvas id="domCanvas" width="800" height="400" style="border: 1px solid #f00"></canvas> <br />
		<button id="btnTriangulize">Triangulize</button>
		<textarea id="txtOutput" rows="15" cols="100"></textarea>
		<script type="text/javascript" src="node_modules/poly2tri/dist/poly2tri.js"></script>
		<script src="dist/NavigationMesh.js"></script>
		<script>

			function triangulize( polygon ){
				var contour = [];
				polygon.points.forEach(function( point ){
					contour.push( new poly2tri.Point( point.x, point.y ) );
				});
				var context = new poly2tri.SweepContext( contour );
				context.triangulate();
				return context.getTriangles();
			}

			function onRender(){
				this.clear();
				this.render();
			}

			function randomHex(){
				return '#'+Math.floor(Math.random()*16777215).toString(16);
			}

			var polygon = new Polygon([]);
			polygon.fill = "#f5f5f5";
			var stage = new Stage();
			stage.addChild( polygon );
			var canvas = new Renderer( document.getElementById("domCanvas") );
			canvas.on( "render", onRender );
			canvas.stage = stage;

			var point;
			canvas.on("click", function( e ){
				point = new Point( e.offsetX, e.offsetY );
				polygon.addPoint( point );
			});

			document.getElementById("btnTriangulize").addEventListener("click", function(){
				if( polygon.points.length < 3 ) return;
				var triangles = triangulize( polygon );
				triangles.forEach(function( triangle ){
					var points = [];
					var poly;
					triangle.getPoints().forEach(function(point){
						points.push( new Point( point.x, point.y ) );
					});
					poly = new Polygon( points );
					poly.fill = "none";
					poly.stroke = "#f00";
					poly.strokeWidth = 1;
					stage.addChild( poly );
					var centroid = poly.centroid;
					var circle = new Circle( centroid.x, centroid.y, 2 );
					circle.fill = "#f00";
					stage.addChild( circle );
				});
				document.getElementById("txtOutput").value = generateOutput( triangles );
			});

			function generateOutput( triangles ){
				console.log( triangles );
				var output = {
					"neighbours": [],
					"points": [],
					"triangles": []
				};
				var pointLookup = {};
				var pointIndex = -1;
				var pointString = null;
				var triangleIndices = null;
				var triangleNeighbours = [];
				// Add ids to triangles
				triangles = triangles.map(function( triangle, index ){
					triangle._ID = index;
					return triangle;
				});
				// Work out shared points
				triangles.forEach(function( triangle ){
					triangleIndices = [];
					triangle.getPoints().forEach(function( point ){
						pointIndex = -1;
						pointString = point.toString();
						if( !pointLookup.hasOwnProperty( pointString ) ){
							pointIndex = output.points.length;
							output.points.push( [ point.x, point.y ] );
							pointLookup[ pointString ] = pointIndex;
						} else {
							pointIndex = pointLookup[ pointString ];
						}
						triangleIndices.push( pointIndex );
					});
					triangleNeighbours = [];
					triangle.neighbors_.forEach(function( neighbor ){
						if( neighbor === null || !neighbor.isInterior() ) return;
						triangleNeighbours.push( neighbor._ID );
					});
					output.neighbours.push( triangleNeighbours );
					output.triangles.push( triangleIndices );
				});
				return JSON.stringify( output );
			}

		</script>
	</body>
</html>