<!DOCTYPE html>
<!--[if lt IE 7]> <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>    <html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>    <html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class=""> <!--<![endif]-->
	<head>  
		<meta charset="utf-8">
		<title></title>
		<meta name="description" content="" />  
		<meta name="keywords" content="" />
		<meta name="robots" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
	</head>
	<body>

		<canvas></canvas>
		<button id="btnCreateMesh">Create mesh</button>
		<button id="btnAddStart">Add start</button>
		<button id="btnAddEnd">Add end</button>
		<button id="btnPathfind">Pathfind</button>

		<script type="text/javascript" src="dist/NavigationMesh.js"></script>
		<script type="text/javascript">

			var WIDTH = 500;
			var HEIGHT = 500;
			var STATE_POINTS = 0;
			var STATE_MESH = 1;
			var STATE_START = 2;
			var STATE_END = 3;
			var STATE_PATH = 4;

			var canvas = document.getElementsByTagName("canvas")[0];
			var ctx = canvas.getContext("2d");

			var points = [];
			var mesh = null;
			var canvasState = STATE_POINTS;
			var debugMessage = [];
			var startPoint = null;
			var endPoint = null;
			var path = null;

			// Mouse coords
			debugMessage.push(new NavigationMesh.Point());
			// Polygon hit test
			debugMessage.push("");

			canvas.width = WIDTH;
			canvas.height = HEIGHT;
			canvas.addEventListener( "click", onCanvasClick, false );
			canvas.addEventListener( "mousemove", onCanvasMousemove, false );

			document.getElementById("btnCreateMesh").addEventListener( "click", onCreateClick, false );
			document.getElementById("btnAddStart").addEventListener( "click", onStartClick, false );
			document.getElementById("btnAddEnd").addEventListener( "click", onEndClick, false );
			document.getElementById("btnPathfind").addEventListener( "click", onPathfindClick, false );

			render();

			function clear(){
				ctx.clearRect( 0, 0, WIDTH, HEIGHT );
			}
			function onCanvasClick( e ){
				console.log( e );

				if( canvasState === STATE_POINTS ){
					points.push( new NavigationMesh.Point( e.offsetX, e.offsetY ) );
					return;
				}

				if( canvasState === STATE_START ){
					if( startPoint === null ){
						startPoint = new NavigationMesh.Point( e.offsetX, e.offsetY );
					} else {
						startPoint.x = e.offsetX;
						startPoint.y = e.offsetY;
					}
					canvasState = STATE_MESH;
					return;
				}

				if( canvasState === STATE_END ){
					if( endPoint === null ){
						endPoint = new NavigationMesh.Point( e.offsetX, e.offsetY );
					} else {
						endPoint.x = e.offsetX;
						endPoint.y = e.offsetY;
					}
					canvasState = STATE_MESH;
					return;
				}

			}
			function onCanvasMousemove(e){
				debugMessage[0].x = e.offsetX;
				debugMessage[0].y = e.offsetY;

				if( canvasState === STATE_MESH ){
					debugMessage[1] = mesh.shape.contains( debugMessage[0] );
				}
			
			}
			function onCreateClick(){
				mesh = new NavigationMesh( points );
				points.length = 0;
				canvasState = STATE_MESH;
			}
			function onStartClick( e ){
				canvasState = STATE_START;
			}
			function onEndClick( e ){
				canvasState = STATE_END;
			}
			function onPathfindClick(){
				canvasState = STATE_PATH;
				path = mesh.route( startPoint, endPoint );
			}
			function render(){
				requestAnimationFrame( render );
				clear();

				ctx.save();

				/**
				 * Render the points
				 */
				if( canvasState === STATE_POINTS ){
					ctx.fillStyle = "#f00";
					ctx.globalAlpha = 0.5;
					points.forEach(function( pt ){
						ctx.beginPath();
						ctx.arc( pt.x, pt.y,5, 0, Math.PI*2, false );
						ctx.closePath();
						ctx.fill();
					});
				}

				/**
				 * Render the points and lines
				 */
				if( canvasState === STATE_MESH || 
						canvasState === STATE_START || 
						canvasState === STATE_END ||
						canvasState === STATE_PATH ){

					var alphaOffset = 0;
					if( canvasState === STATE_PATH ){
						alphaOffset = -0.3;
					}

					ctx.fillStyle = "#0f0";
					ctx.strokeStyle = "#0f0";
					mesh.shape.points.reduce(function( previous, current ){
						// Point
						ctx.globalAlpha = 0.5;
						ctx.beginPath();
						ctx.arc( current.x, current.y,5, 0, Math.PI*2, false );
						ctx.closePath();
						ctx.fill();
						// Line
						ctx.globalAlpha = 1;
						ctx.beginPath();
						ctx.moveTo( previous.x, previous.y );
						ctx.lineTo( current.x, current.y );
						ctx.closePath();
						ctx.stroke();
						return current;
					}, mesh.shape.points[ mesh.shape.points.length - 1 ]);
					ctx.fillStyle = "#00f";
					ctx.strokeStyle = "#00f";
					mesh.graph.nodes.forEach(function( node ){
						ctx.globalAlpha = 0.5 + alphaOffset;
						ctx.beginPath();
						ctx.arc( node.position.x, node.position.y,5, 0, Math.PI*2, false );
						ctx.closePath();
						ctx.fill();
					});
					mesh.graph.links.forEach(function(link){
						ctx.globalAlpha = 1 + alphaOffset;
						ctx.beginPath();
						ctx.moveTo( link.nodes[0].position.x, link.nodes[0].position.y );
						ctx.lineTo( link.nodes[1].position.x, link.nodes[1].position.y );
						ctx.closePath();
						ctx.stroke();
					});

					if( startPoint !== null ){
						ctx.fillStyle = "#FF51F6";
						ctx.globalAlpha = 1;
						ctx.beginPath();
						ctx.arc( startPoint.x, startPoint.y,5, 0, Math.PI*2, false );
						ctx.closePath();
						ctx.fill();
					}
					if( endPoint !== null ){
						ctx.fillStyle = "#A30098";
						ctx.globalAlpha = 1;
						ctx.beginPath();
						ctx.arc( endPoint.x, endPoint.y,5, 0, Math.PI*2, false );
						ctx.closePath();
						ctx.fill();
					}

					if( canvasState === STATE_PATH ){
						ctx.strokeStyle = "#f00";
						ctx.beginPath();
						path.forEach(function(point, index){
							if( index === 0){
								ctx.moveTo( point.x, point.y );
								return;
							}
							ctx.lineTo( point.x, point.y );
						});
						ctx.stroke();
					}

				}

				renderDebug();

				ctx.restore();

			}
			function renderDebug(){
				var output = [];
				debugMessage.forEach(function( value, index ){
					switch( index ){
						case 1:
							if( value === "" ) break;

						default:
							output.push( value );
							break;
					}
				});
				ctx.font = "10px Arial";
				ctx.fillStyle = "#000";
				ctx.globalAlpha = 1;
				ctx.fillText( output.join(" - "), 5, 15 );
			}

		</script>

	</body>
</html>